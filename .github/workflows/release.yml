name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name || github.event.inputs.tag }}
          name: Release ${{ github.ref_name || github.event.inputs.tag }}
          draft: true
          prerelease: false

  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Setup Framework Stubs
        run: |
          # Create stub framework packages for CI
          mkdir -p ../epi-app-framework/dist
          
          # Create main framework package.json with types
          echo '{"name":"@episensor/app-framework","version":"3.6.0","type":"module","main":"dist/index.js","types":"dist/index.d.ts","exports":{".":"./dist/index.js"}}' > ../epi-app-framework/package.json
          
          # Create framework stub files
          echo "export function createLogger(name) { return { info: () => {}, error: () => {}, debug: () => {}, warn: () => {} }; }" > ../epi-app-framework/dist/index.js
          echo "export class StandardServer { constructor() {} async initialize() {} async start() {} getServer() { return {}; } }" >> ../epi-app-framework/dist/index.js
          echo "export class ConfigManager { constructor() {} get() { return {}; } async initialize() {} async update(key, value) { return Promise.resolve(); } reset() {} }" >> ../epi-app-framework/dist/index.js
          echo "export function configureSession(app, options) { return {}; }" >> ../epi-app-framework/dist/index.js
          echo "export function createHealthCheckRouter(options) { return { use: () => {}, get: () => {}, post: () => {} }; }" >> ../epi-app-framework/dist/index.js
          echo "export const logsRouter = { use: () => {}, get: () => {}, post: () => {} };" >> ../epi-app-framework/dist/index.js
          
          # Create type definitions
          echo "export declare function createLogger(name: string): any;" > ../epi-app-framework/dist/index.d.ts
          echo "export declare class StandardServer { constructor(config: any); initialize(): Promise<void>; start(): Promise<void>; getServer(): any; }" >> ../epi-app-framework/dist/index.d.ts
          echo "export declare class ConfigManager { constructor(config: any); get(): any; initialize(): Promise<void>; update(key: string, value: any): Promise<void>; reset(): void; }" >> ../epi-app-framework/dist/index.d.ts
          echo "export declare function configureSession(app: any, options: any): any;" >> ../epi-app-framework/dist/index.d.ts
          echo "export declare function createHealthCheckRouter(options: any): any;" >> ../epi-app-framework/dist/index.d.ts
          echo "export declare const logsRouter: any;" >> ../epi-app-framework/dist/index.d.ts

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm install --no-audit --legacy-peer-deps

      - name: Run tests
        run: npm test

      - name: Build application
        run: npm run build

      - name: Create release archive
        run: |
          mkdir -p release
          cp -r dist release/
          cp package*.json release/
          cp README.md release/
          tar -czf app-template-${{ github.ref_name || github.event.inputs.tag }}.tar.gz -C release .

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name || github.event.inputs.tag }}
          files: ./app-template-${{ github.ref_name || github.event.inputs.tag }}.tar.gz
          draft: true

  publish-release:
    needs: [create-release, build-and-test]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        run: |
          gh release edit "${{ github.ref_name || github.event.inputs.tag }}" --draft=false --repo=${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}